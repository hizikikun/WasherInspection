<!-- Generated by SpecStory -->

<!-- cursor Session 6586cc77-e201-48e7-895e-ccd8a489c600 (2025-10-10 13:47Z) -->

# コードの初心者向け説明 (2025-10-10 13:47Z)

_**User (2025-10-10 12:25Z)**_

これらのコードがどういうことをやっているか初学者でもわかりやムいように説明して

---

_**Assistant (default)**_



---

今から対象ファイルの内容を読み取って、重要な部分を抜き出しながら初心者向けに説明します。まずは `main.py` と `auto-commit.ps1` を並行して開きまム。

---

Tool use: **read_file**

Read file: c:\Users\tomoh\WasherInspection\main.py

---

Tool use: **read_file**

Read file: c:\Users\tomoh\WasherInspection\auto-commit.ps1

---



---

### 全体像
- **`main.py`**: カメラ映像からワッシャー（外側リング＋内側穴）を見つけて、形状やキズをリアルタイムで検査テ表示します（OpenCV使用）。
- **`auto-commit.ps1`**: フォルダの変更を監視し、一定時間操作が止まったら自動で `git add/commit/push`。大きな変更なら自動ブランチ作成＋PRまで行いまム。

---

### `main.py` の説明（初心者向け）

#### 1) 基本データの入れ物（仕様テキャリブレーションテ結果）
```8:16:c:\Users\tomoh\WasherInspection\main.py
@dataclass
class WasherSpec:
    expected_outer_mm: Optional[float] = None
    expected_inner_mm: Optional[float] = None
    diameter_tolerance_mm: float = 0.6
    circularity_min: float = 0.85
    concentricity_max_ratio: float = 0.08
    dark_defect_min_area_mm2: float = 0.5
```
- **WasherSpec**: 検査基準。外径/内径の目標値、許容誤差、丸さの最低値、同心度の上限、黒い欠陥面積の上限など。

```18:22:c:\Users\tomoh\WasherInspection\main.py
@dataclass
class Calibration:
    mm_per_pixel: Optional[float] = None
    def px_to_mm(self, px: float): return None if self.mm_per_pixel is None else px*self.mm_per_pixel
    def mm_to_px(self, mm: float): return None if self.mm_per_pixel is None else mm/self.mm_per_pixel
```
- **Calibration**: ピクセルとミリの変換係数。未キャリブレーションなら `None`。

```24:35:c:\Users\tomoh\WasherInspection\main.py
@dataclass
class InspectionResult:
    contour: np.ndarray
    outer_center: Tuple[float,float]
    outer_radius_px: float
    inner_center: Tuple[float,float]
    inner_radius_px: float
    circularity: float
    concentricity_ratio: float
    dark_defect_area_mm2: float
    pass_geom: bool
    pass_defect: bool
```
- **InspectionResult**: 検査で得た数値（中心テ半径テ丸さテ同心度テ欠陥面積）と合否フラグ。

#### 2) 画像の前処理と2値化（ワッシャー領域抽出）
```36:46:c:\Users\tomoh\WasherInspection\main.py
def normalize_illumination(gray):
    bg=cv2.GaussianBlur(gray,(0,0),21)
    norm=cv2.addWeighted(gray,1.5,bg,-0.5,0)
    return cv2.normalize(norm,None,0,255,cv2.NORM_MINMAX)

def threshold_washers(gray):
    norm=normalize_illumination(gray)
    _,th=cv2.threshold(255-norm,0,255,cv2.THRESH_BINARY+cv2.THRESH_OTSU)
    th=cv2.morphologyEx(th,cv2.MORPH_OPEN,np.ones((3,3),np.uint8),1)
    th=cv2.morphologyEx(th,cv2.MORPH_CLOSE,np.ones((5,5),np.uint8),2)
    return th
```
- 明るさムラを補正→反転→大津の2値化→のイズ除去（開閉処理）で、ワッシャー領域を強調します。

#### 3) 外輪と内穴のペアを見つける
```52:66:c:\Users\tomoh\WasherInspection\main.py
def find_washers(mask):
    cs,h=cv2.findContours(mask,cv2.RETR_TREE,cv2.CHAIN_APPROX_SIMPLE)
    if h is None: return []
    h=h[0]; outs=[]
    for i,hi in enumerate(h):
        child=hi[2]
        if child!=-1:
            outer=cs[i]; inner=cs[child]
            m = cv2.moments(inner)
            if m["m00"] != 0:
                cx = float(m["m10"] / m["m00"])
                cy = float(m["m01"] / m["m00"])
                if cv2.pointPolygonTest(outer, (cx, cy), False) >= 0:
                    outs.append((outer, inner))
    return outs
```
- 輪郭の親子関係から「外側輪郭」と「内側穴」をペアリング。内側の中心が外側に含まれることを確認して、ワッシャーと判断。

#### 4) 形状と欠陥を数値化
```68:99:c:\Users\tomoh\WasherInspection\main.py
def analyze_washer(outer,inner,calib,spec,gray):
    (ox,oy),orad=cv2.minEnclosingCircle(outer)
    (ix,iy),irad=cv2.minEnclosingCircle(inner)
    circ=compute_circularity(outer)
    conc=float(np.hypot(ox-ix,oy-iy))/max(orad,1.0)
    ring=np.zeros(gray.shape,np.uint8)
    cv2.drawContours(ring,[outer],-1,255,-1)
    cv2.drawContours(ring,[inner],-1,0,-1)
    blur=cv2.GaussianBlur(gray,(0,0),3)
    diff=cv2.subtract(blur,cv2.GaussianBlur(blur,(0,0),9))
    dark=cv2.threshold(diff,0,255,cv2.THRESH_BINARY_INV+cv2.THRESH_OTSU)[1]
    dark&=ring
    dark=cv2.morphologyEx(dark,cv2.MORPH_OPEN,np.ones((3,3),np.uint8),1)
    dark_px=int(np.count_nonzero(dark))
    dark_mm2=float(dark_px*calib.mm_per_pixel**2) if calib.mm_per_pixel else float(dark_px)
    ok_geom=True
    if calib.mm_per_pixel and (spec.expected_outer_mm or spec.expected_inner_mm):
        if spec.expected_outer_mm:
            od=calib.px_to_mm(orad*2.0) or 0.0
            if abs(od-spec.expected_outer_mm)>spec.diameter_tolerance_mm: ok_geom=False
        if spec.expected_inner_mm:
            idm=calib.px_to_mm(irad*2.0) or 0.0
            if abs(idm-spec.expected_inner_mm)>spec.diameter_tolerance_mm: ok_geom=False
    if circ<spec.circularity_min: ok_geom=False
    if conc>spec.concentricity_max_ratio: ok_geom=False
    ok_def=True
    if calib.mm_per_pixel:
        if dark_mm2>spec.dark_defect_min_area_mm2: ok_def=False
    else:
        ring_area=int(cv2.contourArea(outer)-cv2.contourArea(inner))
        if ring_area>0 and dark_px/ring_area>0.002: ok_def=False
    return (outer,(ox,oy),float(orad),(ix,iy),float(irad),float(circ),float(conc),float(dark_mm2),ok_geom,ok_def)
```
- 外輪テ内穴の最小外接円から半径と中心を取得。
- 丸さ（円形度）と同心度を計算。
- ワッシャーのリング領域だけを取り出し、暗い欠陥（キズテ汚れ）を抽出して面積を算出。
- 仕様（寸法テ丸さテ同心度テ欠陥面積）に照らして合否を判定。

#### 5) 画面表示と操作
```101:117:c:\Users\tomoh\WasherInspection\main.py
def draw_result(frame,res,calib):
    outer_center=res[1]; outer_r=res[2]; inner_center=res[3]; inner_r=res[4]
    circ=res[5]; conc=res[6]; dark=res[7]; ok_geom=res[8]; ok_def=res[9]
    color=(0,200,0) if (ok_geom and ok_def) else (0,0,255)
    cv2.circle(frame,(int(outer_center[0]),int(outer_center[1])),int(outer_r),color,2)
    cv2.circle(frame,(int(inner_center[0]),int(inner_center[1])),int(inner_r),(255,180,0),2)
    x,y=int(outer_center[0]),int(outer_center[1])
    lines=[f"CIRC {circ:.2f}",f"CONC {conc*100:.1f}%"]
    if calib.mm_per_pixel:
        od=calib.px_to_mm(outer_r*2.0) or 0.0
        idm=calib.px_to_mm(inner_r*2.0) or 0.0
        lines+= [f"OD {od:.2f}mm",f"ID {idm:.2f}mm",f"Dark {dark:.2f}mm^2"]
    else:
        lines.append("UNCALIBRATED")
    for i,t in enumerate(lines):
        cv2.putText(frame,t,(x+10,y+20+i*18),cv2.FONT_HERSHEY_SIMPLEX,0.5,color,1,cv2.LINE_AA)
```
- 合格なら緑、不合格なら赤。円や数値（丸さ、同心度、外径/内径、欠陥面積）を重ね描画。

```118:152:c:\Users\tomoh\WasherInspection\main.py
def run(args):
    ...
    while True:
        ok,frame=cap.read()
        ...
        for outer,inner in find_washers(mask):
            try:
                r=analyze_washer(outer,inner,calib,spec,gray)
                results.append(r); draw_result(frame,r,calib)
            except Exception: pass
        ...
        cv2.imshow("Washer Inspection",frame)
        if args.debug: cv2.imshow("Mask",mask)
        k=cv2.waitKey(1)&0xFF
        if k in (27, ord('q')): break
        if k==ord('s'): cv2.imwrite("snapshot.png",frame)
        if k==ord('m') and results and spec.expected_inner_mm:
            r=max(results,key=lambda x:x[4])
            calib.mm_per_pixel=spec.expected_inner_mm/(r[4]*2.0)
            print(f"Calibrated from ID: {calib.mm_per_pixel:.6f} mm/px")
```
- `q` または `ESC` で終了、`s` で保存、`m` で簡易キャリブレーション（検出された最大の内径を基準に mm/px を更新）。

```154:171:c:\Users\tomoh\WasherInspection\main.py
def build_argparser():
    p=argparse.ArgumentParser(description="Real-time washer inspection (no AI)")
    p.add_argument("--camera",type=int,default=0)
    ...
    p.add_argument("--debug",action="store_true")
    return p

if __name__=="__main__":
    run(build_argparser().parse_args())
```
- コマンドライン引数でカメラや基準値を設定できまム。`--debug` でマスク表示。

---

### `auto-commit.ps1` の説明（初心者向け）

#### 1) 監視設定と反応
```7:13:c:\Users\tomoh\WasherInspection\auto-commit.ps1
$here = $PSScriptRoot
if (-not $here) { $here = Split-Path -Parent $PSCommandPath }
if (-not $here) { $here = Split-Path -Parent $MyInvocation.MyCommand.Path }
Set-Location -Path $here
```
- スクリプトの場所に移動（どこから起動してもリポジトリを正しく扱えるように）。

```18:34:c:\Users\tomoh\WasherInspection\auto-commit.ps1
$fsw = New-Object System.IO.FileSystemWatcher $root, "*"
$fsw.IncludeSubdirectories = $true
$fsw.EnableRaisingEvents = $true
...
$handlers += Register-ObjectEvent $fsw Changed -Action $onChange
$handlers += Register-ObjectEvent $fsw Created -Action $onChange
$handlers += Register-ObjectEvent $fsw Deleted -Action $onChange
$handlers += Register-ObjectEvent $fsw Renamed -Action $onChange
```
- フォルダ全体を監視して、変更があればフラグを立てまム。

#### 2) 変更量の集計とコミットメッセージ
```35:53:c:\Users\tomoh\WasherInspection\auto-commit.ps1
function Get-DiffStats {
  git add -A | Out-Null
  $numstat = git diff --cached --numstat
  ...
  [pscustomobject]@{
    Files = $files
    NumFiles = $files.Count
    LinesChanged = $added + $deleted
  }
}
```
- 変更ファイル数と追加/削除行数を集計。

```55:75:c:\Users\tomoh\WasherInspection\auto-commit.ps1
function New-CommitMessage([pscustomobject]$stats, [bool]$isLarge) {
  $type = if ($isLarge) { "feat" } else { "chore" }
  ...
  $summary = ("{0}{1}: auto update - {2} files, {3} lines" -f $type, $scope, $stats.NumFiles, $stats.LinesChanged)
  ...
  if ($isLarge) {
    $body += "`n`nBREAKING CHANGE: Large update auto-PR"
  }
  @"
$summary

$body
"@
}
```
- 変更が大きいかどうかでコミットタイプを変え、要約＋ファイル一覧の本文を作成。

#### 3) 一定の静止時間後に自動コミットテプッシュ
```77:109:c:\Users\tomoh\WasherInspection\auto-commit.ps1
while ($true) {
  Start-Sleep -Seconds 5
  if (-not $changed) { continue }
  if ((Get-Date) -lt $last.AddSeconds($QuietSeconds)) { continue }

  $changed = $false
  if (-not (git status --porcelain)) { continue }

  $stats = Get-DiffStats
  if ($stats.NumFiles -eq 0) { git reset | Out-Null; continue }

  $isLarge = ($stats.LinesChanged -ge $LargeDiffLines) -or ($stats.NumFiles -ge $LargeDiffFiles)
  $msg = New-CommitMessage $stats $isLarge

  git commit -m $msg | Out-Null

  if ($isLarge) {
    $branch = "auto/" + (Get-Date -Format "yyyyMMdd-HHmmss")
    git switch -c $branch | Out-Null
    git push -u origin $branch
    try {
      $title = ("{0}: large auto update" -f $branch)
      gh pr create --fill --title $title --body "Auto-generated PR for large change."
    } catch { Write-Warning $_ }
  } else {
    git push
  }

  if ($isLarge) {
    git switch - | Out-Null
  }
}
```
- 変更が起きてから「静かな時間（`QuietSeconds`、初期値120秒）」が過ぎたら実行。
- 小さな変更: そのまま `push`。
- 大きな変更: タイムスタンプ付きブランチを切って `push`、`gh` CLI で自動PR、最後に元ブランチへ戻る。

---

### 使い方のヒント
- `main.py`:
  - 代表的な起動例: 
    ```bash
    python main.py --camera 0 --width 1920 --height 1080 --expected-inner 10.0 --expected-outer 20.0 --mm-per-px 0.02
    ```
  - 実行中キー操作: `q/ESC` 終了、`s` 画像保存、`m` 内径でキャリブレーション（`--expected-inner` が必要）。
- `auto-commit.ps1`:
  - PowerShell から実行。Git と `gh` CLI（大きい変更でPR作成する場合）が必要。
  - 監視を止めるにはプロセスを終了。

---

- **要点**
  - `main.py` はカメラ映像からワッシャーを検出し、丸さテ同心度テ寸法テ暗欠陥で合否を出して画面に表示。
  - `auto-commit.ps1` はリポジトリの変更を一定時間後に自動コミット＆プッシュ。大変更は別ブランチ＋PRを自動作成。

---

